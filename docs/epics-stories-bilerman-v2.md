# Epics & Stories: BILERMAN.KG v2

**Версия**: 2.0
**Дата**: 2026-01-28
**Фокус**: Публичный сайт с картой → Клиенты → Партнёры → Сотрудники

---

## Приоритизация по фазам

| Фаза | Описание | Epics | Недели |
|------|----------|-------|--------|
| **1** | Публичный сайт (карта, поиск, PWA) | E1, E2 | 1-3 |
| **2** | Авторизация и бронирование | E3, E4 | 4-5 |
| **3** | Кабинет партнёра + договоры | E5, E6 | 6-8 |
| **4** | Панель сотрудника | E7 | 9-10 |

---

## Epic 1: Карта и поиск (E1) — Фаза 1

**Цель**: Публичная главная страница с интерактивной картой как в 2GIS

### E1-S1: Настройка Mapbox и базовая карта
**Приоритет**: P0
**Оценка**: 4 часа

**Задачи**:
- [ ] Установить `react-map-gl` и `mapbox-gl`
- [ ] Создать компонент `MapView`
- [ ] Настроить Mapbox token
- [ ] Базовый стиль карты (streets или custom)
- [ ] Начальная позиция: Бишкек (42.8746, 74.5698)

**Acceptance Criteria**:
- Карта рендерится на весь экран
- Можно зумить и перемещать
- Работает на мобильных

---

### E1-S2: Геолокация пользователя
**Приоритет**: P0
**Оценка**: 2 часа

**Задачи**:
- [ ] Запрос Geolocation API при загрузке
- [ ] Кнопка "Моё местоположение"
- [ ] Маркер текущей позиции
- [ ] Fallback на Бишкек при отказе

**Acceptance Criteria**:
- Запрашивается разрешение на геолокацию
- Карта центрируется на пользователе
- Виден маркер "Вы здесь"

---

### E1-S3: Маркеры объектов на карте
**Приоритет**: P0
**Оценка**: 6 часов

**Задачи**:
- [ ] API endpoint `GET /api/v1/properties?bounds=...`
- [ ] Загрузка объектов в пределах viewport
- [ ] Кастомные маркеры с ценой
- [ ] Popup при hover/tap (фото, название, цена)
- [ ] Клик → переход на страницу объекта
- [ ] Кластеризация при zoom out

**Acceptance Criteria**:
- Маркеры показывают цену
- При наведении — popup с фото
- Кластеры при большом количестве

---

### E1-S4: Панель фильтров
**Приоритет**: P0
**Оценка**: 8 часов

**Задачи**:
- [ ] Компонент `FilterPanel` (боковая панель)
- [ ] Фильтр по городу (select с поиском)
- [ ] Фильтр по типу объекта (чекбоксы)
- [ ] Фильтр по датам (date range picker)
- [ ] Фильтр по количеству гостей
- [ ] Фильтр по цене (range slider)
- [ ] Фильтр по удобствам (чекбоксы)
- [ ] Кнопка "Сбросить"
- [ ] Применение фильтров → обновление карты

**Acceptance Criteria**:
- Все фильтры работают
- Карта обновляется при изменении
- URL синхронизируется с фильтрами

---

### E1-S5: Поиск по адресу (Geocoding)
**Приоритет**: P0
**Оценка**: 4 часа

**Задачи**:
- [ ] Поле поиска в header
- [ ] Mapbox Geocoding API integration
- [ ] Autocomplete suggestions
- [ ] Выбор → перемещение карты
- [ ] Ограничение по Кыргызстану

**Acceptance Criteria**:
- Ввод "Иссык-Куль" → подсказки
- Выбор → карта перемещается
- Поиск на кыргызском и русском

---

### E1-S6: Список объектов (sidebar/overlay)
**Приоритет**: P0
**Оценка**: 6 часов

**Задачи**:
- [ ] Компонент `PropertyList`
- [ ] Карточки с миниатюрами
- [ ] Виртуализация списка (react-window)
- [ ] Синхронизация с картой (hover → highlight)
- [ ] Mobile: swipe-up sheet
- [ ] Desktop: боковая панель

**Acceptance Criteria**:
- Список показывает отфильтрованные объекты
- Hover на карточке → подсветка маркера
- Клик → страница объекта

---

### E1-S7: Responsive layout (Mobile/Desktop)
**Приоритет**: P0
**Оценка**: 6 часов

**Задачи**:
- [ ] Mobile: карта fullscreen, список снизу (sheet)
- [ ] Mobile: фильтры в drawer
- [ ] Desktop: split view (sidebar + карта)
- [ ] Breakpoints: 768px
- [ ] Touch gestures для карты

**Acceptance Criteria**:
- Удобно на телефоне
- Удобно на десктопе
- Фильтры доступны везде

---

## Epic 2: Страница объекта и PWA (E2) — Фаза 1

**Цель**: Детальная страница объекта + PWA для установки

### E2-S1: Страница объекта — Галерея
**Приоритет**: P0
**Оценка**: 4 часа

**Задачи**:
- [ ] Слайдер фотографий (swiper)
- [ ] Fullscreen режим
- [ ] Thumbnails навигация
- [ ] Lazy loading изображений

**Acceptance Criteria**:
- Свайп между фото
- Клик → fullscreen
- Быстрая загрузка

---

### E2-S2: Страница объекта — Информация
**Приоритет**: P0
**Оценка**: 4 часа

**Задачи**:
- [ ] Название, описание
- [ ] Характеристики (гости, комнаты, кровати)
- [ ] Удобства (иконки + текст)
- [ ] Информация о хозяине
- [ ] Рейтинг и отзывы (placeholder)

**Acceptance Criteria**:
- Вся информация отображается
- Иконки для удобств
- Адаптивный layout

---

### E2-S3: Страница объекта — Карта и локация
**Приоритет**: P0
**Оценка**: 2 часа

**Задачи**:
- [ ] Встроенная карта с маркером
- [ ] Адрес текстом
- [ ] Кнопка "Как добраться" (Google Maps/2GIS)

**Acceptance Criteria**:
- Карта показывает локацию
- Можно открыть в навигаторе

---

### E2-S4: Страница объекта — Календарь доступности
**Приоритет**: P0
**Оценка**: 6 часов

**Задачи**:
- [ ] Календарь на 2 месяца
- [ ] Цветовая индикация (доступно/занято)
- [ ] Выбор дат check-in/check-out
- [ ] Расчёт стоимости при выборе
- [ ] API: `GET /properties/{id}/availability`

**Acceptance Criteria**:
- Видны занятые даты
- Можно выбрать диапазон
- Цена рассчитывается автоматически

---

### E2-S5: Страница объекта — Бронирование (CTA)
**Приоритет**: P0
**Оценка**: 4 часа

**Задачи**:
- [ ] Блок "Забронировать" (sticky на mobile)
- [ ] Отображение цены за выбранные даты
- [ ] Кнопка "Забронировать"
- [ ] Если не авторизован → модалка входа
- [ ] Если авторизован → страница checkout

**Acceptance Criteria**:
- CTA всегда видна
- Показывает итоговую цену
- Редирект на авторизацию если нужно

---

### E2-S6: PWA — Manifest и Service Worker
**Приоритет**: P0
**Оценка**: 4 часа

**Задачи**:
- [ ] `manifest.json` с иконками и темой
- [ ] Service Worker (Vite PWA plugin)
- [ ] Кеширование статики
- [ ] Offline fallback страница
- [ ] Install prompt

**Acceptance Criteria**:
- Можно установить на телефон
- Иконка на рабочем столе
- Работает без сети (базовый shell)

---

### E2-S7: PWA — Иконки и Splash
**Приоритет**: P1
**Оценка**: 2 часа

**Задачи**:
- [ ] Иконки: 192x192, 512x512
- [ ] Apple touch icon
- [ ] Splash screens для iOS
- [ ] Theme color

**Acceptance Criteria**:
- Красивая иконка при установке
- Splash screen при запуске

---

## Epic 3: Авторизация Email (E3) — Фаза 2

**Цель**: Email + Password авторизация

### E3-S1: Backend — Модели и миграции
**Приоритет**: P0
**Оценка**: 3 часа

**Задачи**:
- [ ] Модель User (SQLAlchemy)
- [ ] Миграция таблицы users
- [ ] Хеширование паролей (passlib + bcrypt)
- [ ] Pydantic schemas

**Acceptance Criteria**:
- Таблица users создана в Neon
- Пароли хешируются

---

### E3-S2: Backend — Регистрация
**Приоритет**: P0
**Оценка**: 3 часа

**Задачи**:
- [ ] `POST /api/v1/auth/register`
- [ ] Валидация email (уникальность, формат)
- [ ] Валидация пароля (минимум 8 символов)
- [ ] Создание пользователя
- [ ] Возврат JWT токенов

**Acceptance Criteria**:
- Можно зарегистрироваться
- Возвращаются access и refresh токены
- Ошибка при дубликате email

---

### E3-S3: Backend — Вход
**Приоритет**: P0
**Оценка**: 2 часа

**Задачи**:
- [ ] `POST /api/v1/auth/login`
- [ ] Проверка email + пароль
- [ ] JWT access token (15 мин)
- [ ] JWT refresh token (30 дней)

**Acceptance Criteria**:
- Успешный вход → токены
- Неверный пароль → 401

---

### E3-S4: Backend — Refresh и Logout
**Приоритет**: P0
**Оценка**: 2 часа

**Задачи**:
- [ ] `POST /api/v1/auth/refresh`
- [ ] Обновление access token по refresh
- [ ] Logout (опционально: blacklist)

**Acceptance Criteria**:
- Можно обновить access token
- Сессия длится 30 дней

---

### E3-S5: Frontend — Формы входа и регистрации
**Приоритет**: P0
**Оценка**: 6 часов

**Задачи**:
- [ ] Страница `/login`
- [ ] Страница `/register`
- [ ] Валидация форм (react-hook-form)
- [ ] Отображение ошибок
- [ ] Редирект после успеха

**Acceptance Criteria**:
- Формы работают
- Валидация на клиенте
- Ошибки сервера отображаются

---

### E3-S6: Frontend — Auth Store и Protected Routes
**Приоритет**: P0
**Оценка**: 4 часа

**Задачи**:
- [ ] Zustand store для auth
- [ ] Сохранение токенов в localStorage
- [ ] Auto refresh при истечении
- [ ] Protected route компонент
- [ ] Redirect на login если не авторизован

**Acceptance Criteria**:
- Состояние авторизации сохраняется
- Защищённые роуты работают
- Автообновление токенов

---

## Epic 4: Бронирование (E4) — Фаза 2

**Цель**: Полный цикл бронирования для клиента

### E4-S1: Backend — Модель бронирования
**Приоритет**: P0
**Оценка**: 3 часа

**Задачи**:
- [ ] Модель Booking
- [ ] Миграция
- [ ] Статусы: pending, confirmed, cancelled, completed
- [ ] Связи с Property и User

**Acceptance Criteria**:
- Таблица bookings создана
- Все поля из PRD

---

### E4-S2: Backend — Создание бронирования
**Приоритет**: P0
**Оценка**: 4 часа

**Задачи**:
- [ ] `POST /api/v1/bookings`
- [ ] Проверка доступности дат
- [ ] Расчёт стоимости (ночи × цена + сервисный сбор)
- [ ] Создание записи
- [ ] Блокировка дат

**Acceptance Criteria**:
- Бронирование создаётся
- Даты блокируются
- Конфликты дат обрабатываются

---

### E4-S3: Backend — Мои бронирования
**Приоритет**: P0
**Оценка**: 2 часа

**Задачи**:
- [ ] `GET /api/v1/me/bookings`
- [ ] Список бронирований пользователя
- [ ] Детали `GET /api/v1/bookings/{id}`
- [ ] Фильтры по статусу

**Acceptance Criteria**:
- Клиент видит свои бронирования
- Детали каждого бронирования

---

### E4-S4: Frontend — Checkout страница
**Приоритет**: P0
**Оценка**: 6 часов

**Задачи**:
- [ ] Страница `/checkout/{propertyId}`
- [ ] Сводка бронирования
- [ ] Выбор дат (если не выбраны)
- [ ] Итоговая цена
- [ ] Кнопка "Подтвердить"
- [ ] Успешное бронирование → редирект

**Acceptance Criteria**:
- Понятная сводка
- Можно подтвердить бронирование
- Успех → страница бронирования

---

### E4-S5: Frontend — Мои бронирования
**Приоритет**: P0
**Оценка**: 4 часа

**Задачи**:
- [ ] Страница `/bookings`
- [ ] Список бронирований
- [ ] Статусы (цветовые)
- [ ] Клик → детали

**Acceptance Criteria**:
- Клиент видит историю
- Статусы понятны

---

## Epic 5: Кабинет партнёра (E5) — Фаза 3

**Цель**: Партнёр управляет объектами и видит клиентов

### E5-S1: Backend — Профиль партнёра
**Приоритет**: P0
**Оценка**: 4 часа

**Задачи**:
- [ ] Модель PartnerProfile
- [ ] Миграция partner_profiles
- [ ] API: `GET/PUT /api/v1/partner/profile`
- [ ] Поля: company, inn, bank, documents

**Acceptance Criteria**:
- Партнёр может сохранить реквизиты
- Данные сохраняются в БД

---

### E5-S2: Frontend — Онбординг партнёра
**Приоритет**: P0
**Оценка**: 8 часов

**Задачи**:
- [ ] Мастер из 4 шагов
- [ ] Шаг 1: Тип партнёра
- [ ] Шаг 2: Данные компании
- [ ] Шаг 3: Банковские реквизиты
- [ ] Шаг 4: Загрузка документов
- [ ] Прогресс бар
- [ ] Сохранение на каждом шаге

**Acceptance Criteria**:
- Можно пройти весь онбординг
- Данные сохраняются
- Можно вернуться и изменить

---

### E5-S3: Backend — Мои объекты (CRUD)
**Приоритет**: P0
**Оценка**: 6 часов

**Задачи**:
- [ ] `GET /api/v1/partner/properties`
- [ ] `POST /api/v1/partner/properties`
- [ ] `PUT /api/v1/partner/properties/{id}`
- [ ] `DELETE /api/v1/partner/properties/{id}`
- [ ] Загрузка фото (S3/Cloudinary)

**Acceptance Criteria**:
- Партнёр может создавать объекты
- Может редактировать и удалять
- Фото загружаются

---

### E5-S4: Frontend — Создание объекта (мастер)
**Приоритет**: P0
**Оценка**: 8 часов

**Задачи**:
- [ ] Мастер из 6 шагов
- [ ] Загрузка фото с превью
- [ ] Карта для указания адреса
- [ ] Выбор удобств
- [ ] Предпросмотр

**Acceptance Criteria**:
- Можно создать объект пошагово
- Фото загружаются
- Адрес на карте

---

### E5-S5: Backend — Бронирования партнёра
**Приоритет**: P0
**Оценка**: 3 часа

**Задачи**:
- [ ] `GET /api/v1/partner/bookings`
- [ ] Фильтры: по объекту, статусу, датам
- [ ] Детали с данными клиента

**Acceptance Criteria**:
- Партнёр видит все бронирования
- Видит данные клиентов

---

### E5-S6: Backend — Мои клиенты
**Приоритет**: P1
**Оценка**: 3 часа

**Задачи**:
- [ ] `GET /api/v1/partner/clients`
- [ ] Список уникальных клиентов
- [ ] История бронирований каждого
- [ ] Общая сумма заказов

**Acceptance Criteria**:
- Партнёр видит своих клиентов
- История по каждому

---

### E5-S7: Frontend — Dashboard партнёра
**Приоритет**: P0
**Оценка**: 6 часов

**Задачи**:
- [ ] Страница `/partner/dashboard`
- [ ] Виджеты: баланс, статистика
- [ ] Навигация: объекты, бронирования, клиенты
- [ ] Быстрые действия

**Acceptance Criteria**:
- Удобный dashboard
- Ключевые метрики видны

---

## Epic 6: Автогенерация договоров (E6) — Фаза 3

**Цель**: Автоматическое создание PDF договора при бронировании

### E6-S1: Шаблон договора
**Приоритет**: P1
**Оценка**: 4 часа

**Задачи**:
- [ ] Создать шаблон договора аренды
- [ ] Placeholders для данных
- [ ] Юридическая корректность (консультация)
- [ ] Форматы: HTML → PDF

**Acceptance Criteria**:
- Шаблон готов
- Все placeholder'ы определены

---

### E6-S2: Backend — Генерация PDF
**Приоритет**: P1
**Оценка**: 6 часов

**Задачи**:
- [ ] Библиотека: weasyprint или reportlab
- [ ] Сервис ContractService
- [ ] Подстановка данных партнёра
- [ ] Подстановка данных клиента
- [ ] Подстановка данных бронирования
- [ ] Генерация PDF
- [ ] Сохранение в storage

**Acceptance Criteria**:
- PDF генерируется
- Все данные корректны
- Файл сохраняется

---

### E6-S3: Интеграция с бронированием
**Приоритет**: P1
**Оценка**: 3 часа

**Задачи**:
- [ ] При создании бронирования → генерация договора
- [ ] Сохранение URL в booking.contract_url
- [ ] Таблица contracts для истории
- [ ] Email с договором обеим сторонам

**Acceptance Criteria**:
- Договор создаётся автоматически
- Доступен для скачивания
- Отправляется по email

---

### E6-S4: Frontend — Просмотр и скачивание
**Приоритет**: P1
**Оценка**: 2 часа

**Задачи**:
- [ ] Кнопка "Скачать договор" в деталях бронирования
- [ ] Предпросмотр PDF (опционально)

**Acceptance Criteria**:
- Можно скачать договор
- Доступен партнёру и клиенту

---

## Epic 7: Панель сотрудника (E7) — Фаза 4

**Цель**: Сотрудники видят всё в разрезе компаний/объектов/клиентов

### E7-S1: Backend — Staff API
**Приоритет**: P2
**Оценка**: 6 часов

**Задачи**:
- [ ] Middleware проверки роли staff
- [ ] `GET /api/v1/staff/partners` — все партнёры
- [ ] `GET /api/v1/staff/properties` — все объекты
- [ ] `GET /api/v1/staff/clients` — все клиенты
- [ ] `GET /api/v1/staff/bookings` — все бронирования
- [ ] Фильтры по всем параметрам

**Acceptance Criteria**:
- Staff видит всё
- Фильтры работают

---

### E7-S2: Frontend — Staff Dashboard
**Приоритет**: P2
**Оценка**: 8 часов

**Задачи**:
- [ ] Страница `/staff/dashboard`
- [ ] Общая статистика платформы
- [ ] Навигация по разделам
- [ ] Фильтры: по компании, региону

**Acceptance Criteria**:
- Общий обзор платформы
- Ключевые метрики

---

### E7-S3: Frontend — Управление партнёрами
**Приоритет**: P2
**Оценка**: 6 часов

**Задачи**:
- [ ] Таблица партнёров
- [ ] Фильтр по компании, статусу верификации
- [ ] Клик → детали партнёра
- [ ] Объекты партнёра
- [ ] Бронирования партнёра

**Acceptance Criteria**:
- Полный список партнёров
- Drill-down в детали

---

### E7-S4: Frontend — Модерация объектов
**Приоритет**: P2
**Оценка**: 4 часа

**Задачи**:
- [ ] Список объектов на модерации
- [ ] Просмотр деталей
- [ ] Одобрить / Отклонить
- [ ] Комментарий при отклонении

**Acceptance Criteria**:
- Можно модерировать объекты
- Партнёр получает уведомление

---

### E7-S5: Frontend — Все бронирования
**Приоритет**: P2
**Оценка**: 4 часа

**Задачи**:
- [ ] Таблица всех бронирований
- [ ] Фильтры: дата, статус, партнёр, объект
- [ ] Детали бронирования
- [ ] Действия: отменить, пометить спор

**Acceptance Criteria**:
- Полный обзор бронирований
- Можно фильтровать

---

## Сводка по спринтам

### Sprint 1-2 (недели 1-3): Публичный сайт
- E1: Карта и поиск (все stories)
- E2: Страница объекта и PWA (все stories)

**Результат**: Рабочий публичный сайт с картой, можно смотреть объекты

### Sprint 3 (недели 4-5): Авторизация и бронирование
- E3: Авторизация Email (все stories)
- E4: Бронирование (все stories)

**Результат**: Клиенты могут регистрироваться и бронировать

### Sprint 4-5 (недели 6-8): Кабинет партнёра
- E5: Кабинет партнёра (все stories)
- E6: Автогенерация договоров (все stories)

**Результат**: Партнёры могут добавлять объекты, видеть клиентов, получать договоры

### Sprint 6 (недели 9-10): Панель сотрудника
- E7: Панель сотрудника (все stories)

**Результат**: Staff видит всё, может модерировать

---

## Definition of Done

Для каждой story:
- [ ] Код написан и работает
- [ ] Покрыт тестами (минимум unit)
- [ ] Code review пройден
- [ ] Задеплоено на staging
- [ ] Проверено на mobile и desktop
- [ ] Acceptance Criteria выполнены

---

**Документ подготовлен**: 2026-01-28
**Общее количество stories**: ~40
**Оценка**: 10 недель
