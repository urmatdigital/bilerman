# Epics & Stories: BILERMAN.KG

**Версия**: 1.0
**Дата**: 2026-01-28
**Методология**: Agile/Scrum

---

## Обзор эпиков

| # | Epic | Stories | Приоритет | Спринт |
|---|------|---------|-----------|--------|
| E1 | Ребрендинг | 5 | P0 | 1 |
| E2 | OTP Аутентификация | 6 | P0 | 1 |
| E3 | Платежи и Эскроу | 10 | P0 | 2-3 |
| E4 | Бронирование v2 | 7 | P0 | 2 |
| E5 | Отмены и неустойки | 5 | P1 | 3 |
| E6 | Dashboard партнёра | 6 | P1 | 3-4 |
| E7 | Верификация | 4 | P1 | 4 |
| E8 | Уведомления | 4 | P1 | 4 |
| E9 | Админ-панель | 5 | P2 | 5 |
| E10 | Удаление legacy | 4 | P2 | 1 |

**Итого**: ~56 stories на 5 спринтов (2 недели каждый)

---

## Epic 1: Ребрендинг (E1)

**Цель**: Трансформировать визуальную идентичность из KONOK в BILERMAN.KG

### E1-S1: Обновление конфигурации и метаданных
**Описание**: Изменить название приложения, URL, метатеги во всех конфигурационных файлах.

**Задачи**:
- [ ] Обновить `frontend/src/config/index.ts`
- [ ] Обновить `frontend/index.html` (title, meta)
- [ ] Обновить `frontend/vite.config.ts` (PWA manifest)
- [ ] Обновить `backend/.env` примеры
- [ ] Обновить README.md

**Acceptance Criteria**:
- Название "BILERMAN.KG" отображается везде
- Meta tags содержат правильное описание
- PWA manifest обновлён

---

### E1-S2: Новая цветовая схема
**Описание**: Внедрить цвета из брендбука BOOGUARD (синий + оранжевый).

**Задачи**:
- [ ] Обновить `tailwind.config.js` с новыми цветами
- [ ] Обновить CSS переменные для dark/light mode
- [ ] Проверить все компоненты на соответствие новой палитре

**Acceptance Criteria**:
- Primary цвет = оранжевый (#f97316)
- Secondary цвет = синий (#3b82f6)
- Фоновый цвет = тёмно-синий (#1e3a5f) для hero секций
- Все кнопки и акценты используют новые цвета

---

### E1-S3: Логотип и иконки
**Описание**: Создать и внедрить новый логотип BILERMAN.KG.

**Задачи**:
- [ ] Создать логотип (SVG)
- [ ] Создать favicon (16x16, 32x32, 180x180)
- [ ] Создать PWA иконки (192x192, 512x512)
- [ ] Создать Open Graph изображение (1200x630)
- [ ] Обновить все места использования логотипа

**Acceptance Criteria**:
- Логотип отображается в header
- Favicon виден во вкладке браузера
- PWA устанавливается с правильной иконкой

---

### E1-S4: Обновление Landing Page
**Описание**: Переработать главную страницу под концепцию безопасного бронирования.

**Задачи**:
- [ ] Новый Hero блок с УТП "Деньги защищены до заселения"
- [ ] Секция "Как это работает" (4 шага)
- [ ] Секция преимуществ для клиентов
- [ ] Секция преимуществ для партнёров
- [ ] CTA блоки

**Acceptance Criteria**:
- Hero содержит ключевое сообщение
- Визуально соответствует BOOGUARD презентации
- Есть чёткие CTA кнопки

---

### E1-S5: Страница для партнёров
**Описание**: Создать лендинг для привлечения арендодателей.

**Задачи**:
- [ ] Контент из BOOGUARD_КП_Партнёры.pdf
- [ ] Секция "Проблемы" (боли арендодателей)
- [ ] Секция "Решение" (CRM, защита)
- [ ] Условия сотрудничества (10% комиссия)
- [ ] Форма заявки на подключение

**Acceptance Criteria**:
- Страница доступна по /partners
- Форма отправляет данные (email/Telegram)
- Контент на русском и кыргызском

---

## Epic 2: OTP Аутентификация (E2)

**Цель**: Заменить email+password на вход по SMS OTP

### E2-S1: Интеграция SMS провайдера
**Описание**: Подключить API для отправки SMS (Nikita.kg или аналог).

**Задачи**:
- [ ] Создать `backend/sms/provider.py`
- [ ] Реализовать метод `send_sms(phone, message)`
- [ ] Добавить конфигурацию (API ключи)
- [ ] Написать тесты (mock)
- [ ] Обработка ошибок и retry

**Acceptance Criteria**:
- SMS отправляется на реальный номер
- Логируются все отправки
- Обрабатываются ошибки API

---

### E2-S2: Backend: API запроса OTP
**Описание**: Эндпоинт для запроса OTP кода.

**Задачи**:
- [ ] `POST /api/v1/auth/request-otp`
- [ ] Валидация формата телефона (+996XXXXXXXXX)
- [ ] Генерация 6-значного кода
- [ ] Сохранение в Redis (TTL 5 минут)
- [ ] Отправка SMS
- [ ] Rate limiting (1 SMS в минуту)

**Acceptance Criteria**:
```
POST /api/v1/auth/request-otp
Body: {"phone": "+996700123456"}
Response: {"message": "OTP sent", "expires_in": 300}
```

---

### E2-S3: Backend: API верификации OTP
**Описание**: Эндпоинт для проверки OTP и получения токенов.

**Задачи**:
- [ ] `POST /api/v1/auth/verify-otp`
- [ ] Проверка кода из Redis
- [ ] Создание пользователя если не существует
- [ ] Генерация JWT access + refresh токенов
- [ ] Удаление OTP из Redis после использования

**Acceptance Criteria**:
```
POST /api/v1/auth/verify-otp
Body: {"phone": "+996700123456", "code": "123456"}
Response: {"access_token": "...", "refresh_token": "...", "user": {...}}
```

---

### E2-S4: Миграция БД: users таблица
**Описание**: Обновить схему пользователей для OTP.

**Задачи**:
- [ ] Добавить колонку `phone VARCHAR(20) UNIQUE`
- [ ] Сделать `email` nullable
- [ ] Удалить `hashed_password` (или оставить nullable)
- [ ] Создать индекс по phone
- [ ] Миграция существующих данных

**Acceptance Criteria**:
- Схема применяется без ошибок
- Существующие пользователи сохранены
- Новые пользователи создаются по телефону

---

### E2-S5: Frontend: Форма входа по телефону
**Описание**: Новый UI для входа/регистрации.

**Задачи**:
- [ ] Step 1: Ввод номера телефона (маска +996)
- [ ] Step 2: Ввод 6-значного кода
- [ ] Таймер повторной отправки (60 сек)
- [ ] Обработка ошибок
- [ ] Редирект после успеха

**Acceptance Criteria**:
- Пользователь может войти по телефону
- Отображается таймер до повторной отправки
- Показываются понятные ошибки

---

### E2-S6: Frontend: Auth store и сервис
**Описание**: Обновить Zustand store и API сервис.

**Задачи**:
- [ ] Обновить `auth.service.ts` (requestOTP, verifyOTP)
- [ ] Обновить `auth.store.ts`
- [ ] Обновить типы User (phone вместо email)
- [ ] Обновить protected routes

**Acceptance Criteria**:
- Store корректно хранит состояние
- Токены сохраняются в localStorage
- Автоматический refresh токенов работает

---

## Epic 3: Платежи и Эскроу (E3)

**Цель**: Реализовать систему оплаты с эскроу-защитой

### E3-S1: Модели данных платежей
**Описание**: Создать модели Payment, Payout, CompensationFund.

**Задачи**:
- [ ] Модель `Payment` (SQLAlchemy)
- [ ] Модель `Payout`
- [ ] Модель `FundTransaction`
- [ ] Миграция БД
- [ ] Pydantic schemas

**Acceptance Criteria**:
- Таблицы созданы в БД
- Модели имеют все необходимые поля
- Связи между таблицами корректны

---

### E3-S2: Абстракция платёжного провайдера
**Описание**: Создать базовый класс для платёжных интеграций.

**Задачи**:
- [ ] `backend/payments/base.py` - абстрактный класс
- [ ] Интерфейс: create_payment, verify_payment, refund, payout
- [ ] Фабрика провайдеров

**Acceptance Criteria**:
- Можно легко добавить новый провайдер
- Единый интерфейс для всех провайдеров

---

### E3-S3: Интеграция MBank
**Описание**: Реализовать оплату через MBank.

**Задачи**:
- [ ] Изучить API MBank
- [ ] Реализовать `MBankProvider`
- [ ] Генерация QR-кода/deep link
- [ ] Webhook для подтверждения
- [ ] Тестирование в sandbox

**Acceptance Criteria**:
- Можно создать платёж
- Webhook обрабатывает успешную оплату
- Статус обновляется в БД

---

### E3-S4: Эскроу сервис
**Описание**: Логика удержания и распределения средств.

**Задачи**:
- [ ] `backend/payments/escrow.py`
- [ ] `hold_payment()` - зафиксировать на эскроу
- [ ] `release_to_partner()` - выплата после check-in
- [ ] `refund_to_client()` - возврат при отмене
- [ ] Расчёт комиссии (10%)

**Acceptance Criteria**:
- После оплаты статус = ESCROW
- После check-in средства готовы к выплате
- Комиссия 10% остаётся на платформе

---

### E3-S5: API платежей
**Описание**: REST endpoints для работы с платежами.

**Задачи**:
- [ ] `POST /api/v1/payments/create` - инициировать платёж
- [ ] `POST /api/v1/payments/webhook/{provider}` - webhook
- [ ] `GET /api/v1/payments/{id}` - статус платежа
- [ ] `GET /api/v1/payments/booking/{booking_id}` - платёж по бронированию

**Acceptance Criteria**:
- API документировано в Swagger
- Webhook защищён подписью
- Статусы возвращаются корректно

---

### E3-S6: Frontend: Checkout страница
**Описание**: UI для оформления и оплаты.

**Задачи**:
- [ ] Сводка бронирования (даты, цена)
- [ ] Выбор способа оплаты
- [ ] Отображение QR-кода MBank
- [ ] Polling статуса или WebSocket
- [ ] Страница успеха/ошибки

**Acceptance Criteria**:
- Пользователь видит детали перед оплатой
- QR-код отображается корректно
- После оплаты редирект на успех

---

### E3-S7: Выплаты партнёрам - Backend
**Описание**: Автоматические выплаты после check-in.

**Задачи**:
- [ ] Cron job / Celery task для выплат
- [ ] Проверка бронирований со статусом checked_in
- [ ] Создание Payout записи
- [ ] Вызов API провайдера для перевода
- [ ] Обновление статусов

**Acceptance Criteria**:
- Выплата происходит через 24 часа после check-in
- Партнёр получает 90% суммы
- Статус Payment = RELEASED

---

### E3-S8: Настройки выплат партнёра
**Описание**: UI для указания реквизитов выплат.

**Задачи**:
- [ ] Форма в настройках партнёра
- [ ] Выбор метода (MBank, Элсом, банк)
- [ ] Ввод реквизитов
- [ ] Валидация данных

**Acceptance Criteria**:
- Партнёр может указать реквизиты
- Данные сохраняются в профиле
- Используются при выплате

---

### E3-S9: История платежей и выплат
**Описание**: UI для просмотра финансовой истории.

**Задачи**:
- [ ] Таблица платежей (для админа)
- [ ] Таблица выплат партнёра
- [ ] Фильтры по дате, статусу
- [ ] Экспорт в CSV

**Acceptance Criteria**:
- Партнёр видит свои выплаты
- Админ видит все транзакции
- Можно фильтровать и экспортировать

---

### E3-S10: Интеграция O!Dengi и Элсом
**Описание**: Добавить альтернативные способы оплаты.

**Задачи**:
- [ ] `OdengiProvider`
- [ ] `ElsomProvider`
- [ ] UI выбора провайдера
- [ ] Тестирование

**Acceptance Criteria**:
- Работают все 3 способа оплаты
- UI понятен для пользователя

---

## Epic 4: Бронирование v2 (E4)

**Цель**: Обновить flow бронирования под эскроу модель

### E4-S1: Обновление статусов бронирования
**Описание**: Новые статусы с учётом эскроу.

**Задачи**:
- [ ] Добавить статусы: pending_payment, escrow, checked_in
- [ ] Обновить enum в модели
- [ ] Миграция существующих данных
- [ ] Обновить state machine

**Acceptance Criteria**:
- Все статусы из PRD реализованы
- Переходы между статусами валидируются

---

### E4-S2: Создание бронирования с платежом
**Описание**: Связать создание бронирования с оплатой.

**Задачи**:
- [ ] При создании бронирования → статус pending_payment
- [ ] Создание Payment записи
- [ ] Таймаут 15 минут на оплату
- [ ] Автоотмена при неоплате

**Acceptance Criteria**:
- Бронирование создаётся в pending_payment
- Если не оплачено за 15 мин → отменяется
- Даты блокируются временно

---

### E4-S3: Подтверждение check-in
**Описание**: Механизм подтверждения заселения.

**Задачи**:
- [ ] Кнопка "Гость заселился" для партнёра
- [ ] API endpoint для check-in
- [ ] Автоматический check-in через 2 часа после времени заезда
- [ ] Триггер выплаты

**Acceptance Criteria**:
- Партнёр может подтвердить check-in
- Автоматический check-in работает
- После check-in запускается выплата

---

### E4-S4: Обновление формы бронирования
**Описание**: Улучшить UX создания бронирования.

**Задачи**:
- [ ] Калькулятор цены (ночи × цена + сервисный сбор)
- [ ] Отображение политики отмены
- [ ] Checkbox согласия с условиями
- [ ] Кнопка "Перейти к оплате"

**Acceptance Criteria**:
- Цена рассчитывается автоматически
- Политика отмены видна до бронирования
- Пользователь должен согласиться с условиями

---

### E4-S5: Страница бронирования клиента
**Описание**: Детальная страница бронирования.

**Задачи**:
- [ ] Статус бронирования (визуальный)
- [ ] Контакты партнёра (после подтверждения)
- [ ] Кнопка "Отменить" (с предупреждением о возврате)
- [ ] Чат с партнёром
- [ ] Оставить отзыв (после check-out)

**Acceptance Criteria**:
- Клиент видит актуальный статус
- Может отменить с расчётом возврата
- Может связаться с партнёром

---

### E4-S6: Список бронирований партнёра
**Описание**: Обновить таблицу бронирований партнёра.

**Задачи**:
- [ ] Фильтры по статусу
- [ ] Кнопка check-in
- [ ] Информация о платеже и выплате
- [ ] Быстрые действия

**Acceptance Criteria**:
- Партнёр видит все бронирования
- Может подтвердить check-in
- Видит статус выплаты

---

### E4-S7: Уведомления о бронировании
**Описание**: SMS уведомления на ключевых этапах.

**Задачи**:
- [ ] SMS при создании бронирования
- [ ] SMS при успешной оплате
- [ ] SMS напоминание за 1 день
- [ ] SMS при отмене

**Acceptance Criteria**:
- Клиент и партнёр получают SMS
- Текст сообщений понятный
- Работает на реальных номерах

---

## Epic 5: Отмены и неустойки (E5)

**Цель**: Реализовать систему отмен с расчётом возвратов и штрафов

### E5-S1: Политики отмены в объекте
**Описание**: Добавить выбор политики отмены.

**Задачи**:
- [ ] Поле `cancellation_policy` в Property
- [ ] UI выбора при создании/редактировании
- [ ] Отображение на странице объекта
- [ ] Описание каждой политики

**Acceptance Criteria**:
- Партнёр может выбрать политику
- Клиент видит политику перед бронированием

---

### E5-S2: Сервис расчёта возврата
**Описание**: Backend логика расчёта возврата.

**Задачи**:
- [ ] `CancellationService`
- [ ] Расчёт по дням до заезда
- [ ] Учёт политики объекта
- [ ] Расчёт штрафа для партнёра

**Acceptance Criteria**:
- Корректный расчёт по всем политикам
- Тесты на граничные случаи

---

### E5-S3: API отмены бронирования
**Описание**: Endpoints для отмены.

**Задачи**:
- [ ] `POST /api/v1/bookings/{id}/cancel` (клиент)
- [ ] `POST /api/v1/bookings/{id}/cancel-by-partner` (партнёр)
- [ ] Возврат информации о сумме возврата/штрафа
- [ ] Интеграция с эскроу для возврата

**Acceptance Criteria**:
- Отмена работает для обеих сторон
- Деньги возвращаются/удерживаются корректно

---

### E5-S4: UI отмены для клиента
**Описание**: Интерфейс отмены бронирования.

**Задачи**:
- [ ] Кнопка "Отменить бронирование"
- [ ] Модальное окно с расчётом возврата
- [ ] Подтверждение отмены
- [ ] Обновление статуса на странице

**Acceptance Criteria**:
- Клиент видит сумму возврата ДО отмены
- Требуется подтверждение
- Статус обновляется мгновенно

---

### E5-S5: Логирование штрафов партнёра
**Описание**: Учёт неустоек для партнёров.

**Задачи**:
- [ ] Таблица partner_penalties
- [ ] Запись при отмене партнёром
- [ ] Отображение в профиле партнёра
- [ ] Влияние на рейтинг (опционально)

**Acceptance Criteria**:
- Все штрафы записываются
- Партнёр видит историю
- Админ может просмотреть

---

## Epic 6: Dashboard партнёра (E6)

**Цель**: Улучшить панель управления для арендодателей

### E6-S1: Виджет баланса
**Описание**: Отображение финансов на dashboard.

**Задачи**:
- [ ] Доступно к выводу (суммы после check-in)
- [ ] Ожидает (суммы на эскроу)
- [ ] Выведено за месяц
- [ ] Кнопка "История выплат"

**Acceptance Criteria**:
- Баланс отображается корректно
- Обновляется в реальном времени

---

### E6-S2: Запрос на вывод средств
**Описание**: Механизм вывода средств по запросу.

**Задачи**:
- [ ] Кнопка "Вывести средства"
- [ ] Выбор суммы (или всё доступное)
- [ ] Подтверждение реквизитов
- [ ] Создание Payout запроса

**Acceptance Criteria**:
- Партнёр может запросить вывод
- Минимальная сумма 500 сом
- Выплата обрабатывается

---

### E6-S3: Календарь бронирований
**Описание**: Визуальный календарь для партнёра.

**Задачи**:
- [ ] Календарный вид по месяцам
- [ ] Цветовая индикация статусов
- [ ] Клик на дату → детали бронирования
- [ ] Блокировка дат вручную

**Acceptance Criteria**:
- Наглядный календарь
- Можно блокировать даты
- Видны все бронирования

---

### E6-S4: Статистика объектов
**Описание**: Аналитика по объектам партнёра.

**Задачи**:
- [ ] Доход за период
- [ ] Количество бронирований
- [ ] Процент загрузки
- [ ] Средний чек

**Acceptance Criteria**:
- Статистика рассчитывается корректно
- Можно выбрать период
- Графики наглядные

---

### E6-S5: Управление объектами
**Описание**: CRUD операции с объектами.

**Задачи**:
- [ ] Список объектов с статусами
- [ ] Создание нового объекта
- [ ] Редактирование
- [ ] Активация/деактивация
- [ ] Удаление (с проверкой бронирований)

**Acceptance Criteria**:
- Все операции работают
- Нельзя удалить с активными бронированиями
- Статус модерации виден

---

### E6-S6: Настройки профиля партнёра
**Описание**: Страница настроек.

**Задачи**:
- [ ] Персональные данные
- [ ] Реквизиты для выплат
- [ ] Уведомления (SMS on/off)
- [ ] Верификация документов

**Acceptance Criteria**:
- Можно обновить данные
- Реквизиты сохраняются
- Документы можно загрузить

---

## Epic 7: Верификация (E7)

### E7-S1: Загрузка документов партнёра
### E7-S2: Модерация партнёров (админ)
### E7-S3: Верификация объектов
### E7-S4: Значки верификации в UI

---

## Epic 8: Уведомления (E8)

### E8-S1: Шаблоны SMS сообщений
### E8-S2: Триггеры отправки
### E8-S3: Push уведомления (PWA)
### E8-S4: Логирование и статистика

---

## Epic 9: Админ-панель (E9)

### E9-S1: Dashboard с метриками
### E9-S2: Модерация объектов
### E9-S3: Управление пользователями
### E9-S4: Арбитраж споров
### E9-S5: Финансовые отчёты

---

## Epic 10: Удаление legacy (E10)

### E10-S1: Удалить модуль клинеров
**Задачи**:
- [ ] Удалить `frontend/src/pages/cleaner/`
- [ ] Удалить `backend/models/cleaner.py`
- [ ] Удалить роутинг клинеров
- [ ] Удалить таблицы из БД

---

### E10-S2: Удалить интеграции платформ
**Задачи**:
- [ ] Удалить `backend/integration_service/`
- [ ] Удалить UI интеграций
- [ ] Удалить связанные таблицы

---

### E10-S3: Удалить микросервисы
**Задачи**:
- [ ] Отключить `communication_service`
- [ ] Отключить `pricing_analytics_service`
- [ ] Отключить `copilot`

---

### E10-S4: Переименование и рефакторинг
**Задачи**:
- [ ] guest → client
- [ ] owner → partner
- [ ] Обновить все импорты и ссылки

---

## Приоритизация спринтов

### Sprint 1 (недели 1-2): Фундамент
- E1: Ребрендинг (все stories)
- E2: OTP Аутентификация (все stories)
- E10: Удаление legacy (все stories)

**Цель**: Новый бренд, новый вход, чистый код

### Sprint 2 (недели 3-4): Платежи
- E3-S1 → E3-S6: Модели, MBank, эскроу, checkout

**Цель**: Работающая оплата с эскроу

### Sprint 3 (недели 5-6): Бронирование + Отмены
- E4: Бронирование v2 (все stories)
- E5: Отмены и неустойки (все stories)

**Цель**: Полный цикл бронирования

### Sprint 4 (недели 7-8): Партнёры
- E6: Dashboard партнёра (все stories)
- E3-S7 → E3-S9: Выплаты

**Цель**: Готовый продукт для партнёров

### Sprint 5 (недели 9-10): Финализация
- E7: Верификация
- E8: Уведомления
- E9: Админ-панель
- E3-S10: Дополнительные платёжные методы

**Цель**: MVP готов к запуску

---

**Документ подготовлен**: 2026-01-28
**Общее количество stories**: ~56
**Оценка**: 10 недель (5 спринтов по 2 недели)
